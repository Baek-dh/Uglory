<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="subscriptionMapper">
	
	
	<!-- 결제 번호 생성 -->
	<select id="createSOrderNo" resultType="string">
		SELECT 
		<choose>
	   		<when test='box == 1'>
				CONCAT(TO_CHAR(SYSDATE, '"S"YYYYMMDD-"00"'), SEQ_S_ORDER_CD.NEXTVAL) as temp
			</when>
	   		<otherwise>
				CONCAT(TO_CHAR(SYSDATE, '"J"YYYYMMDD-"00"'), SEQ_S_ORDER_CD.NEXTVAL) as temp
			</otherwise>
		</choose>
		FROM DUAL
	</select>
	
	
	<!-- 첫배송일 지정 -->
	<select id="createDelDate" resultType="date">
		SELECT NEXT_DAY(SYSDATE, '수요일') FROM DUAL
	</select>
	
	
	<!-- 주문 삽입 -->
	<insert id="insertSubsOrder">
		INSERT INTO SUBS_ORDER VALUES(
			#{subsOrderNo},
			DEFAULT, DEFAULT,
			#{orderName},
			#{orderPhone},
			#{orderAddress},
			#{delText},
			#{firstDelDate},
	        DEFAULT,
          	#{cycle},
           	#{memberNo},
           	#{box}
	       )
	</insert>
	
	<!-- 구독 중인지 확인 -->
	<select id="checkSubs" resultType="string">
		SELECT * FROM
		   (SELECT * FROM SUBS_ORDER
		   WHERE MEMBER_NO = #{memberNo}
		   AND S_CANCEL = 'N')
		WHERE ROWNUM=1
	</select>
	
	
	<!-- 제외 상품 삽입 -->
	<insert id="exception">
		INSERT INTO SUBS_EXCEPTION 
		
		<foreach collection="choice" item="item" open="(" close=")" separator=" UNION ALL ">
			SELECT #{item}, #{subsOrderNo} FROM DUAL
		</foreach>
		
	</insert>
	
	
	<!-- 구독 결제정보 삽입 -->
	<insert id="insertPay">
		INSERT INTO SUBS_PAY VALUES(
		   #{payNo}, 
		   SYSDATE,
		   #{amount},
		   #{memberNo},
		   #{subsOrderNo}
		)
	</insert>
	
</mapper>
