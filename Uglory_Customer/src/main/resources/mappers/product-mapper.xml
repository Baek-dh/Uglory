<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="productMapper">

	<!-- 상품 상세조회용 resultMap -->   
  	<resultMap type="detail" id="detail_rm">
    	<id property="productCode" column="P_CD"/>
      	<result property="productName" column="PRODUCT_NM"/>
      	<result property="productPrice" column="PRODUCT_PRICE"/>
      	<result property="productInfo" column="RODUCT_INFO"/>
      	
      	<result property="optionName" column="OPTION_NM"/>
      	<result property="optionPrice" column="OPTION_PRICE"/>
      	
      	<result property="producer" column="PRODUCER"/>
      	<result property="origin" column="ORIGIN"/>
      	
      	<result property="star" column="STAR_RATING"/>

    </resultMap>
    
    <!-- 주문 페이지 내 선택한 옵션에 따른 조회 결과를 담은 resultMap -->
	<resultMap type="OptionType" id="orderOptionProduct_rm">
		<id property="productCode" column="P_CD"/>
		<result property="optionCode" column="OPTION_CD"/>
		<result property="optionName" column="OPTION_NM"/>
		<result property="optionPrice" column="OPTION_PRICE"/>
		<result property="productName" column="PRODUCT_NM"/>
		<result property="productCategoryNo" column="P_CATEGORY_NO"/>
	</resultMap>
     
    <!-- 상품 상세 조회 -->
    <!-- 별점 개수, 리뷰 개수 필요 -->
	<select id="productDetail" resultMap="detail_rm">
<!-- 		SELECT P_CD, PRODUCT_NM, PRODUCT_PRICE, PRODUCT_INFO,
      	OPTION_NM, OPTION_PRICE, PRODUCT_IMG,
      	PRODUCER, ORIGIN, STAR_RATING
      	FROM PRODUCT
      	JOIN OPTION_TYPE USING(P_CD)
      	JOIN FARM USING(FARM_NO)
      	JOIN REVIEW USING(P_CD)
      	JOIN PRODUCT_IMG USING(P_CD)
      	WHERE P_CD = ${pCode} -->
      	
		SELECT P_CD, PRODUCT_NM, PRODUCT_PRICE, PRODUCT_INFO, P_CATEGORY_NO, PRODUCER, ORIGIN
		FROM PRODUCT
		JOIN FARM USING(FARM_NO)
		WHERE P_CD = ${productCode}
	</select>
	
	
	<!-- 주문 페이지 내 옵션 조회 -->
	<select id="orderOptionSelect"  resultMap="orderOptionProduct_rm">
		SELECT OPTION_CD, OPTION_NM, OPTION_PRICE, PRODUCT_NM, P_CD, P_CATEGORY.P_CATEGORY_NO
		FROM OPTION_TYPE
		JOIN PRODUCT USING(P_CD)
		JOIN P_CATEGORY ON(PRODUCT.P_CATEGORY_NO = P_CATEGORY.P_CATEGORY_NO)
		WHERE P_CD = ${productCode}
		AND OPTION_CD IN 
		<foreach item="item" collection="optionCodeList" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>
	
	<!-- 주문번호 생성 -->
	<select id="createProductOrderCode" resultType="string">
		SELECT CONCAT(TO_CHAR(SYSDATE, 'YYYYMMDD-"00"'), SEQ_P_ORDER_CD.NEXTVAL) as temp FROM DUAL
	</select>
	
	<!-- 주문정보 입력 -->
	<insert id="productOrder">
		INSERT INTO PRODUCT_ORDER VALUES (
				#{pOrderCode},
				SYSDATE, 
				#{pOrderName}, 
				#{pOrderPhone}, 
				#{pOrderAddress},
				#{totalAmount}, 
				#{pOrderReq}, 
				'N', 
				#{memberNo}, 
				1)
	</insert>
	
	<!-- 결제 정보 삽입 -->
	<insert id="productPay">
		INSERT INTO PRODUCT_PAY VALUES(
			#{productPayNo},
			SYSDATE,
			#{totalAmount},
			#{memberNo},
			#{pOrderCode})		
	</insert>

</mapper>

